name: 'Test: Jest Performance Tests Cronjob'

on:
  push:
    branches:
      - Piotrk39/feat.add-performance-tests-automatically
  schedule:
    - cron: '42 1 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  workingDirectory: services/121-service/
  EXTERNAL_121_SERVICE_URL: http://localhost:3000

jobs:
  path-filter:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.filter.outputs.should_skip }}
    steps:
      - uses: actions/checkout@v6
        if: github.event_name == 'pull_request'
        with:
          filter: blob:none
          fetch-depth: 0

      - uses: leavesster/pull-request-path-filter@v0.2
        if: github.event_name == 'pull_request'
        id: 'filter'
        with:
          paths: |
            - .github/workflows/test_service_api.yml
            - .github/actions/build-service/action.yml
            - services/.env.example
            - services/121-service/**
            - services/mock-service/**
            - '!**.md'

  generate-test-matrix:
    runs-on: ubuntu-latest
    needs: path-filter
    if: ${{ needs.path-filter.outputs.should_skip != 'true' }}
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v6

      - name: Generate test matrix
        id: generate-matrix
        working-directory: ${{ env.workingDirectory }}
        run: |
          # Group tests by shard number (process each shard individually)
          matrix='['
          first=true

          # Process each shard individually (1, 2, 3)
          for shard in 1 2 3; do
            # Find all test files for this shard
            test_files=""
            file_first=true

            for file in test/performance/*.test.ts; do
              if [ -f "$file" ] && grep -q "const PERFORMANCE_TEST_SHARD = $shard" "$file"; then
                filename=$(basename "$file")
                if [ "$file_first" = true ]; then
                  test_files="$filename"
                  file_first=false
                else
                  test_files="$test_files,$filename"
                fi
              fi
            done

            if [ ! -z "$test_files" ]; then
              if [ "$first" = true ]; then
                first=false
              else
                matrix="${matrix},"
              fi
              matrix="${matrix}{\"shard\":\"${shard}\",\"test_files\":\"${test_files}\"}"
            fi
          done

          matrix="${matrix}]"
          echo "Generated test matrix (grouped by shard):"
          echo "$matrix" | jq . 2>/dev/null || echo "Matrix (raw): $matrix"

          # Show shard breakdown
          echo "Shard breakdown:"
          for shard in 1 2 3; do
            count=$(grep -l "const PERFORMANCE_TEST_SHARD = $shard" test/performance/*.test.ts 2>/dev/null | wc -l)
            if [ $count -gt 0 ]; then
              echo "  Shard $shard: $count tests"
            fi
          done

          # Validate matrix is not empty
          if [ "$matrix" = '[]' ]; then
            echo "ERROR: No performance tests found with PERFORMANCE_TEST_SHARD constants"
            exit 1
          fi
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  performance-test-shard:
    runs-on: ubuntu-latest
    needs: [path-filter, generate-test-matrix]
    if: ${{ needs.path-filter.outputs.should_skip != 'true' }}

    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.generate-test-matrix.outputs.matrix) }}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v6

      - name: Set ENV-variables for test-environment
        run: |
          cp ./services/.env.example services/.env
          grep -v "^#\|^$" services/.env.example >> $GITHUB_ENV

      - name: Run Services with Docker
        run: |
          npm run start:services:ci

      - name: Run performance tests - Shard ${{ matrix.shard }}
        working-directory: ${{ env.workingDirectory }}
        run: |
          echo "üöÄ Running performance tests for shard ${{ matrix.shard }}"
          echo "Tests to run: ${{ matrix.test_files }}"

          # Split the test files and run each one
          IFS=',' read -ra TESTS <<< "${{ matrix.test_files }}"

          for test_file in "${TESTS[@]}"; do
            echo "üìã Running test: $test_file"

            if ! docker compose exec -e CI=true -e GITHUB_WORKFLOW="${{ github.workflow }}" 121-service npm run test:integration:base -t "$test_file"; then
              echo "‚ùå Test failed: $test_file"
              echo "Check the logs above for detailed error information"
              exit 1
            fi

            echo "‚úÖ Test passed: $test_file"
            echo "---"
          done

          echo "üéâ All tests in shard ${{ matrix.shard }} completed successfully!"

      - name: Docker logs
        if: always()
        uses: jwalton/gh-docker-logs@v2

  performance-test-shard-resolution:
    runs-on: ubuntu-latest
    needs: [performance-test-shard]
    if: always()
    steps:
      - name: Check test results - FAILURE
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "## ‚ùå Performance Tests Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more performance tests have failed. Check the individual test logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results Summary:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJson(needs.performance-test-shard.result) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Check test results - SUCCESS
        if: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
        run: |
          echo "## ‚úÖ All Performance Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All performance tests have successfully completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results:" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo '${{ toJson(needs.*.result) }}' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # - name: Microsoft Teams Notification
      #   if: always()
      #   uses: tlolkema/simple-teams-message@main
      #   env:
      #     JOB_STATUS_WITH_NICE_EMOJI: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
      #   with:
      #     message_title: 'Jest Performance Tests Cronjob'
      #     message_description: 'Job status: ${{ env.JOB_STATUS_WITH_NICE_EMOJI }}'
      #     webhook: ${{ secrets.MSTEAMS_WEBHOOK }}
