name: 'Test: Jest Performance Tests Cronjob'

on:
  push:
    branches:
      - Piotrk39/feat.add-performance-tests-automatically
  schedule:
    - cron: '42 1 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  workingDirectory: services/121-service/
  EXTERNAL_121_SERVICE_URL: http://localhost:3000

jobs:
  path-filter:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.filter.outputs.should_skip }}
    steps:
      - uses: actions/checkout@v6
        if: github.event_name == 'pull_request'
        with:
          filter: blob:none
          fetch-depth: 0
      - uses: leavesster/pull-request-path-filter@v0.2
        if: github.event_name == 'pull_request'
        id: 'filter'
        with:
          paths: |
            - .github/workflows/test_service_api.yml
            - .github/actions/build-service/action.yml
            - services/.env.example
            - services/121-service/**
            - services/mock-service/**
            - '!**.md'
  generate-test-files:
    runs-on: ubuntu-latest
    outputs:
      shard1_files: ${{ steps.discover.outputs.shard1_files }}
      long_test_1: ${{ steps.discover.outputs.long_test_1 }}
      long_test_2: ${{ steps.discover.outputs.long_test_2 }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v6
      - name: Set up test files per shard
        id: discover
        run: |
          LONG_TEST_1="payment-100k-registration-intersolve-visa.test.ts"
          LONG_TEST_2="performance-during-payment.test.ts"
          SHARD1_FILES=$(find services/121-service/test/performance -name '*.test.ts' ! -name "$LONG_TEST_1" ! -name "$LONG_TEST_2" -print0 | xargs -0 -n1 basename | sort | xargs | tr ' ' ',')
          echo "üîç Discovered shard 1 files: $SHARD1_FILES"
          echo "üîç Long test 1: $LONG_TEST_1"
          echo "üîç Long test 2: $LONG_TEST_2"
          {
            echo "shard1_files=$SHARD1_FILES"
            echo "long_test_1=$LONG_TEST_1"
            echo "long_test_2=$LONG_TEST_2"
          } >> $GITHUB_OUTPUT

  performance-test-shard:
    runs-on: ubuntu-latest
    needs: [path-filter, generate-test-files]
    if: ${{ needs.path-filter.outputs.should_skip != 'true' }}
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
        include:
          - shard: 1
            test_files: ${{ needs.generate-test-files.outputs.shard1_files }}
          - shard: 2
            test_files: ${{ needs.generate-test-files.outputs.long_test_1 }}
          - shard: 3
            test_files: ${{ needs.generate-test-files.outputs.long_test_2 }}

    steps:
      - name: Check out repository code
        uses: actions/checkout@v6

      - name: Set ENV-variables for test-environment
        run: |
          cp ./services/.env.example services/.env
          grep -v "^#\|^$" services/.env.example >> $GITHUB_ENV

      - name: Run Services with Docker
        run: |
          npm run start:services:ci

      - name: Run performance tests - Shard ${{ matrix.shard }}
        working-directory: ${{ env.workingDirectory }}
        run: |
          echo "üöÄ Running tests for shard ${{ matrix.shard }}"
          echo "üìã Test files: ${{ matrix.test_files }}"

          IFS=',' read -ra TESTS <<< "${{ matrix.test_files }}"

          if [[ ${#TESTS[@]} -eq 0 || ( ${#TESTS[@]} -eq 1 && -z "${TESTS[0]}" ) ]]; then
            echo "‚ö†Ô∏è No test files found for shard ${{ matrix.shard }}"
            exit 0
          fi

          for test_file in "${TESTS[@]}"; do
            if [[ -n "$test_file" ]]; then
              echo "üß™ Running test: $test_file"
              docker compose exec -e CI=true -e HIGH_DATA_VOLUME=true -e GITHUB_WORKFLOW="${{ github.workflow }}" 121-service npm run test:integration:base -t "$test_file"
              echo "‚úÖ Completed test: $test_file"
            fi
          done

      - name: Docker logs
        if: always()
        uses: jwalton/gh-docker-logs@v2

  performance-test-shard-resolution:
    runs-on: ubuntu-latest
    needs: [performance-test-shard]
    if: always()
    steps:
      - name: Check test results - FAILURE
        if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
        run: |
          echo "Performance tests have failed." >> $GITHUB_STEP_SUMMARY
          echo "Test results: ${{ toJson(needs.*.result) }}" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Check test results - SUCCESS
        if: ${{ !(contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
        run: |
          echo "All performance tests have successfully passed." >> $GITHUB_STEP_SUMMARY
          echo "Test results: ${{ toJson(needs.*.result) }}" >> $GITHUB_STEP_SUMMARY

      - name: Microsoft Teams Notification
        if: always()
        uses: tlolkema/simple-teams-message@main
        env:
          JOB_STATUS_WITH_NICE_EMOJI: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}
        with:
          message_title: 'Jest Performance Tests Cronjob'
          message_description: 'Job status: ${{ env.JOB_STATUS_WITH_NICE_EMOJI }}'
          webhook: ${{ secrets.MSTEAMS_WEBHOOK }}
