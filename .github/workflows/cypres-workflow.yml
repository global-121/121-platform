name: "Cypress"


on:
  push:
    branches:
    - 'wip.cypress-github-actions'

jobs:
  test:
    name: Run Cypress Tests
    runs-on: ubuntu-18.04
    # permissions:
    #   actions: read
    #   contents: read
    #   security-events: write

    # strategy:
    #   fail-fast: false
    #   matrix:
    #     language: ['javascript']

    steps:

    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '14.20'
        cache: 'npm'
        cache-dependency-path: |
          interfaces/HO-Portal/package-lock.json
          interfaces/AW-App/package-lock.json
          interfaces/PA-App/package-lock.json

    - name: Set .env
      run: cp services/.env.cypress services/.env

    - name: Start services
      run: cd services/ && docker-compose -f docker-compose.yml -f docker-compose.development.yml up -d --build

    - name: Version npm

      run: npm -v

    - name: Version node
      run: node -v

    - name: Install Interfaces
      run: npm run install:interfaces

    - name: Start Interfaces
      run: npm run start:interfaces:cypress


    # - name: Sleep for 120 seconds
    #   run: sleep 120s
    #   shell: bash
    - name: Install wait port
      run: npm install -g wait-port
    - name: Wait for PA
      run: wait-port -t 120000 localhost:8008
    - name: Wait for AW
      run: wait-port -t 120000 localhost:8080
    - name: Wait for HO
      run: wait-port -t 120000 localhost:8888


    - name: Curl test
      run: curl -I http://localhost:8888

    - name: Run integration tests with cypress.
      uses: cypress-io/github-action@v4.2.0
      with:
        build: npx cypress info
        browser: chrome
        start: npm run start:cypress:run
        wait-on: 'http://localhost:8888/'
        wait-on-timeout: 210
        working-directory: ./interfaces/tests
