import { MigrationInterface, QueryRunner } from "typeorm";

export class ViewRemainingPayment1693403228152 implements MigrationInterface {
    name = 'ViewRemainingPayment1693403228152'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`CREATE VIEW "121-service"."registration_view_entity" AS SELECT "registration"."id" AS "id", "registration"."programId" AS "programId", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."noteUpdated" AS "noteUpdated", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "financialServiceProvider", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal", CAST(CONCAT('PA #',registration."registrationProgramId") as VARCHAR) AS "registrationProgramId", "amountPaymentsReceived" - "maxPayments" AS "amountPaymentsRemaining", transaction_max_payment."amountPaymentsReceived" AS "amountPaymentsReceived" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId"  LEFT JOIN (SELECT MAX("payment") AS "payment", COUNT(DISTINCT(payment)) AS "amountPaymentsReceived", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "registrationId") "transaction_max_payment" ON transaction_max_payment."registrationId" = "registration"."id" ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","VIEW","registration_view_entity","SELECT \"registration\".\"id\" AS \"id\", \"registration\".\"programId\" AS \"programId\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"noteUpdated\" AS \"noteUpdated\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"financialServiceProvider\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\", CAST(CONCAT('PA #',registration.\"registrationProgramId\") as VARCHAR) AS \"registrationProgramId\", \"amountPaymentsReceived\" - \"maxPayments\" AS \"amountPaymentsRemaining\", transaction_max_payment.\"amountPaymentsReceived\" AS \"amountPaymentsReceived\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\"  LEFT JOIN (SELECT MAX(\"payment\") AS \"payment\", COUNT(DISTINCT(payment)) AS \"amountPaymentsReceived\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"registrationId\") \"transaction_max_payment\" ON transaction_max_payment.\"registrationId\" = \"registration\".\"id\" ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`CREATE VIEW "121-service"."registration_view_entity" AS SELECT "registration"."id" AS "id", "registration"."programId" AS "programId", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."noteUpdated" AS "noteUpdated", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "financialServiceProvider", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal", CAST(CONCAT('PA #',registration."registrationProgramId") as VARCHAR) AS "registrationProgramId", "amountPaymentsReceived" - "maxPayments" AS "amountPaymentsRemaining" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId"  LEFT JOIN (SELECT MAX("payment") AS "payment", COUNT(DISTINCT(payment)) AS "amountPaymentsReceived", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "registrationId") "transaction_max_payment" ON transaction_max_payment."registrationId" = "registration"."id" ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","VIEW","registration_view_entity","SELECT \"registration\".\"id\" AS \"id\", \"registration\".\"programId\" AS \"programId\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"noteUpdated\" AS \"noteUpdated\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"financialServiceProvider\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\", CAST(CONCAT('PA #',registration.\"registrationProgramId\") as VARCHAR) AS \"registrationProgramId\", \"amountPaymentsReceived\" - \"maxPayments\" AS \"amountPaymentsRemaining\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\"  LEFT JOIN (SELECT MAX(\"payment\") AS \"payment\", COUNT(DISTINCT(payment)) AS \"amountPaymentsReceived\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"registrationId\") \"transaction_max_payment\" ON transaction_max_payment.\"registrationId\" = \"registration\".\"id\" ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

}
