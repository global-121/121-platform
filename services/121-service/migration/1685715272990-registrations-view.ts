import { MigrationInterface, QueryRunner } from "typeorm";

export class RegistrationsView1685715272990 implements MigrationInterface {
    name = 'RegistrationsView1685715272990'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`CREATE VIEW "121-service"."registration_view_entity" AS SELECT DISTINCT ON ("registration"."registrationProgramId") "registration"."id" AS "id", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."registrationProgramId" AS "registrationProgramId", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "fsp", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal", "transaction"."created" AS "paymentDate", "transaction"."payment" AS payment, "transaction"."status" AS "transactionStatus", "transaction"."amount" AS "transactionAmount", "transaction"."errorMessage" as "errorMessage", "transaction"."customData" as "customData", transaction_max_payment."nrPayments" as "nrPayments" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId"  LEFT JOIN (SELECT MAX("payment") AS "payment", COUNT(DISTINCT(payment)) AS "nrPayments", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "registrationId") "transaction_max_payment" ON transaction_max_payment."registrationId" = "registration"."id"  LEFT JOIN (SELECT MAX("transactionStep") AS "transactionStep", "payment" AS "payment", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "registrationId") "transaction_max_transaction_step" ON transaction_max_transaction_step."registrationId" = registration.id
      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX("created") AS "created", "payment" AS "payment", "transactionStep" AS "transactionStep", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "transactionStep", "registrationId") "transaction_max_created" ON transaction_max_created."registrationId" = registration.id
      AND transaction_max_created.payment = transaction_max_payment.payment
      AND transaction_max_created."transactionStep" = transaction_max_transaction_step."transactionStep"  LEFT JOIN "121-service"."transaction" "transaction" ON "transaction"."registrationId"="registration"."id" AND (transaction."registrationId" = transaction_max_created."registrationId"
      AND "transaction"."payment" = transaction_max_created.payment
      AND transaction."transactionStep" = transaction_max_created."transactionStep"
      AND transaction."created" = transaction_max_created."created") WHERE 1 = 1 ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","VIEW","registration_view_entity","SELECT DISTINCT ON (\"registration\".\"registrationProgramId\") \"registration\".\"id\" AS \"id\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"registrationProgramId\" AS \"registrationProgramId\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"fsp\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\", \"transaction\".\"created\" AS \"paymentDate\", \"transaction\".\"payment\" AS payment, \"transaction\".\"status\" AS \"transactionStatus\", \"transaction\".\"amount\" AS \"transactionAmount\", \"transaction\".\"errorMessage\" as \"errorMessage\", \"transaction\".\"customData\" as \"customData\", transaction_max_payment.\"nrPayments\" as \"nrPayments\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\"  LEFT JOIN (SELECT MAX(\"payment\") AS \"payment\", COUNT(DISTINCT(payment)) AS \"nrPayments\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"registrationId\") \"transaction_max_payment\" ON transaction_max_payment.\"registrationId\" = \"registration\".\"id\"  LEFT JOIN (SELECT MAX(\"transactionStep\") AS \"transactionStep\", \"payment\" AS \"payment\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"registrationId\") \"transaction_max_transaction_step\" ON transaction_max_transaction_step.\"registrationId\" = registration.id\n      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX(\"created\") AS \"created\", \"payment\" AS \"payment\", \"transactionStep\" AS \"transactionStep\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"transactionStep\", \"registrationId\") \"transaction_max_created\" ON transaction_max_created.\"registrationId\" = registration.id\n      AND transaction_max_created.payment = transaction_max_payment.payment\n      AND transaction_max_created.\"transactionStep\" = transaction_max_transaction_step.\"transactionStep\"  LEFT JOIN \"121-service\".\"transaction\" \"transaction\" ON \"transaction\".\"registrationId\"=\"registration\".\"id\" AND (transaction.\"registrationId\" = transaction_max_created.\"registrationId\"\n      AND \"transaction\".\"payment\" = transaction_max_created.payment\n      AND transaction.\"transactionStep\" = transaction_max_created.\"transactionStep\"\n      AND transaction.\"created\" = transaction_max_created.\"created\") WHERE 1 = 1 ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`CREATE VIEW "121-service"."registration_view_entity" AS SELECT DISTINCT ON ("registration"."registrationProgramId") "registration"."id" AS "id", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."registrationProgramId" AS "registrationProgramId", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "fsp", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId" WHERE 1 = 1 ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","VIEW","registration_view_entity","SELECT DISTINCT ON (\"registration\".\"registrationProgramId\") \"registration\".\"id\" AS \"id\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"registrationProgramId\" AS \"registrationProgramId\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"fsp\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\" WHERE 1 = 1 ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

}
