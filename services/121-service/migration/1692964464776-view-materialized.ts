import { MigrationInterface, QueryRunner } from "typeorm";

export class ViewMaterialized1692964464776 implements MigrationInterface {
    name = 'ViewMaterialized1692964464776'

    public async up(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`ALTER TABLE "121-service"."twilio_message" ADD CONSTRAINT "FK_cd56d3267e8553557ec97c6741b" FOREIGN KEY ("transactionId") REFERENCES "121-service"."transaction"("id") ON DELETE NO ACTION ON UPDATE NO ACTION`);
        await queryRunner.query(`CREATE MATERIALIZED VIEW "121-service"."registration_view_entity" AS SELECT DISTINCT ON ("registration"."registrationProgramId") "registration"."id" AS "id", "registration"."programId" AS "programId", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."noteUpdated" AS "noteUpdated", "registration"."registrationProgramId" AS "registrationProgramId", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "financialServiceProvider", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal", "transaction"."created" AS "lastTransactionCreated", "transaction"."payment" AS "lastTransactionPaymentNumber", "transaction"."status" AS "lastTransactionStatus", "transaction"."amount" AS "lastTransactionAmount", "transaction"."errorMessage" as "lastTransactionErrorMessage", "transaction"."customData" as "lastTransactionCustomData", transaction_max_payment."amountPaymentsReceived" as "amountPaymentsReceived", "imported".created AS "importedDate", "registered".created AS "registeredDate", "invited".created AS "invitedDate", "startedRegistration".created AS "startedRegistrationDate", "selectedForValidation".created AS "selectedForValidationDate", "validated".created AS "validationDate", "included".created AS "inclusionDate", "rejected".created AS "rejectionDate", "noLongerEligible".created AS "noLongerEligibleDate", "registeredWhileNoLongerEligible".created AS "registeredWhileNoLongerEligibleDate", "inclusionEnded".created AS "inclusionEndDate", "deleted".created AS "deleteDate", "completed".created AS "completedDate", "twilioMessages"."status" AS "lastMessageStatus", "twilioMessages"."type" AS "lastMessageType" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId"  LEFT JOIN (SELECT MAX("payment") AS "payment", COUNT(DISTINCT(payment)) AS "amountPaymentsReceived", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "registrationId") "transaction_max_payment" ON transaction_max_payment."registrationId" = "registration"."id"  LEFT JOIN (SELECT MAX("transactionStep") AS "transactionStep", "payment" AS "payment", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "registrationId") "transaction_max_transaction_step" ON transaction_max_transaction_step."registrationId" = registration.id
      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX("created") AS "created", "payment" AS "payment", "transactionStep" AS "transactionStep", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "transactionStep", "registrationId") "transaction_max_created" ON transaction_max_created."registrationId" = registration.id
      AND transaction_max_created.payment = transaction_max_payment.payment
      AND transaction_max_created."transactionStep" = transaction_max_transaction_step."transactionStep"  LEFT JOIN "121-service"."transaction" "transaction" ON "transaction"."registrationId"="registration"."id" AND (transaction."registrationId" = transaction_max_created."registrationId"
      AND "transaction"."payment" = transaction_max_created.payment
      AND transaction."transactionStep" = transaction_max_created."transactionStep"
      AND transaction."created" = transaction_max_created."created")  LEFT JOIN "121-service"."registration_status_change" "imported" ON "registration"."id" = "imported"."registrationId" AND "imported"."registrationStatus" = 'imported'  LEFT JOIN "121-service"."registration_status_change" "registered" ON "registration"."id" = "registered"."registrationId" AND "registered"."registrationStatus" = 'registered'  LEFT JOIN "121-service"."registration_status_change" "invited" ON "registration"."id" = "invited"."registrationId" AND "invited"."registrationStatus" = 'invited'  LEFT JOIN "121-service"."registration_status_change" "startedRegistration" ON "registration"."id" = "startedRegistration"."registrationId" AND "startedRegistration"."registrationStatus" = 'startedRegistration'  LEFT JOIN "121-service"."registration_status_change" "selectedForValidation" ON "registration"."id" = "selectedForValidation"."registrationId" AND "selectedForValidation"."registrationStatus" = 'selectedForValidation'  LEFT JOIN "121-service"."registration_status_change" "validated" ON "registration"."id" = "validated"."registrationId" AND "validated"."registrationStatus" = 'validated'  LEFT JOIN "121-service"."registration_status_change" "included" ON "registration"."id" = "included"."registrationId" AND "included"."registrationStatus" = 'included'  LEFT JOIN "121-service"."registration_status_change" "rejected" ON "registration"."id" = "rejected"."registrationId" AND "rejected"."registrationStatus" = 'rejected'  LEFT JOIN "121-service"."registration_status_change" "noLongerEligible" ON "registration"."id" = "noLongerEligible"."registrationId" AND "noLongerEligible"."registrationStatus" = 'noLongerEligible'  LEFT JOIN "121-service"."registration_status_change" "registeredWhileNoLongerEligible" ON "registration"."id" = "registeredWhileNoLongerEligible"."registrationId" AND "registeredWhileNoLongerEligible"."registrationStatus" = 'registeredWhileNoLongerEligible'  LEFT JOIN "121-service"."registration_status_change" "inclusionEnded" ON "registration"."id" = "inclusionEnded"."registrationId" AND "inclusionEnded"."registrationStatus" = 'inclusionEnded'  LEFT JOIN "121-service"."registration_status_change" "deleted" ON "registration"."id" = "deleted"."registrationId" AND "deleted"."registrationStatus" = 'deleted'  LEFT JOIN "121-service"."registration_status_change" "completed" ON "registration"."id" = "completed"."registrationId" AND "completed"."registrationStatus" = 'completed'  LEFT JOIN (SELECT MAX("created") AS "created", "registrationId" AS "registrationId" FROM "121-service"."twilio_message" "messages" GROUP BY "registrationId") "messages_max_created" ON messages_max_created."registrationId" = "registration"."id"  LEFT JOIN "121-service"."twilio_message" "twilioMessages" ON "twilioMessages"."registrationId"="registration"."id" AND ("twilioMessages"."created" = messages_max_created.created) ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","MATERIALIZED_VIEW","registration_view_entity","SELECT DISTINCT ON (\"registration\".\"registrationProgramId\") \"registration\".\"id\" AS \"id\", \"registration\".\"programId\" AS \"programId\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"noteUpdated\" AS \"noteUpdated\", \"registration\".\"registrationProgramId\" AS \"registrationProgramId\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"financialServiceProvider\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\", \"transaction\".\"created\" AS \"lastTransactionCreated\", \"transaction\".\"payment\" AS \"lastTransactionPaymentNumber\", \"transaction\".\"status\" AS \"lastTransactionStatus\", \"transaction\".\"amount\" AS \"lastTransactionAmount\", \"transaction\".\"errorMessage\" as \"lastTransactionErrorMessage\", \"transaction\".\"customData\" as \"lastTransactionCustomData\", transaction_max_payment.\"amountPaymentsReceived\" as \"amountPaymentsReceived\", \"imported\".created AS \"importedDate\", \"registered\".created AS \"registeredDate\", \"invited\".created AS \"invitedDate\", \"startedRegistration\".created AS \"startedRegistrationDate\", \"selectedForValidation\".created AS \"selectedForValidationDate\", \"validated\".created AS \"validationDate\", \"included\".created AS \"inclusionDate\", \"rejected\".created AS \"rejectionDate\", \"noLongerEligible\".created AS \"noLongerEligibleDate\", \"registeredWhileNoLongerEligible\".created AS \"registeredWhileNoLongerEligibleDate\", \"inclusionEnded\".created AS \"inclusionEndDate\", \"deleted\".created AS \"deleteDate\", \"completed\".created AS \"completedDate\", \"twilioMessages\".\"status\" AS \"lastMessageStatus\", \"twilioMessages\".\"type\" AS \"lastMessageType\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\"  LEFT JOIN (SELECT MAX(\"payment\") AS \"payment\", COUNT(DISTINCT(payment)) AS \"amountPaymentsReceived\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"registrationId\") \"transaction_max_payment\" ON transaction_max_payment.\"registrationId\" = \"registration\".\"id\"  LEFT JOIN (SELECT MAX(\"transactionStep\") AS \"transactionStep\", \"payment\" AS \"payment\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"registrationId\") \"transaction_max_transaction_step\" ON transaction_max_transaction_step.\"registrationId\" = registration.id\n      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX(\"created\") AS \"created\", \"payment\" AS \"payment\", \"transactionStep\" AS \"transactionStep\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"transactionStep\", \"registrationId\") \"transaction_max_created\" ON transaction_max_created.\"registrationId\" = registration.id\n      AND transaction_max_created.payment = transaction_max_payment.payment\n      AND transaction_max_created.\"transactionStep\" = transaction_max_transaction_step.\"transactionStep\"  LEFT JOIN \"121-service\".\"transaction\" \"transaction\" ON \"transaction\".\"registrationId\"=\"registration\".\"id\" AND (transaction.\"registrationId\" = transaction_max_created.\"registrationId\"\n      AND \"transaction\".\"payment\" = transaction_max_created.payment\n      AND transaction.\"transactionStep\" = transaction_max_created.\"transactionStep\"\n      AND transaction.\"created\" = transaction_max_created.\"created\")  LEFT JOIN \"121-service\".\"registration_status_change\" \"imported\" ON \"registration\".\"id\" = \"imported\".\"registrationId\" AND \"imported\".\"registrationStatus\" = 'imported'  LEFT JOIN \"121-service\".\"registration_status_change\" \"registered\" ON \"registration\".\"id\" = \"registered\".\"registrationId\" AND \"registered\".\"registrationStatus\" = 'registered'  LEFT JOIN \"121-service\".\"registration_status_change\" \"invited\" ON \"registration\".\"id\" = \"invited\".\"registrationId\" AND \"invited\".\"registrationStatus\" = 'invited'  LEFT JOIN \"121-service\".\"registration_status_change\" \"startedRegistration\" ON \"registration\".\"id\" = \"startedRegistration\".\"registrationId\" AND \"startedRegistration\".\"registrationStatus\" = 'startedRegistration'  LEFT JOIN \"121-service\".\"registration_status_change\" \"selectedForValidation\" ON \"registration\".\"id\" = \"selectedForValidation\".\"registrationId\" AND \"selectedForValidation\".\"registrationStatus\" = 'selectedForValidation'  LEFT JOIN \"121-service\".\"registration_status_change\" \"validated\" ON \"registration\".\"id\" = \"validated\".\"registrationId\" AND \"validated\".\"registrationStatus\" = 'validated'  LEFT JOIN \"121-service\".\"registration_status_change\" \"included\" ON \"registration\".\"id\" = \"included\".\"registrationId\" AND \"included\".\"registrationStatus\" = 'included'  LEFT JOIN \"121-service\".\"registration_status_change\" \"rejected\" ON \"registration\".\"id\" = \"rejected\".\"registrationId\" AND \"rejected\".\"registrationStatus\" = 'rejected'  LEFT JOIN \"121-service\".\"registration_status_change\" \"noLongerEligible\" ON \"registration\".\"id\" = \"noLongerEligible\".\"registrationId\" AND \"noLongerEligible\".\"registrationStatus\" = 'noLongerEligible'  LEFT JOIN \"121-service\".\"registration_status_change\" \"registeredWhileNoLongerEligible\" ON \"registration\".\"id\" = \"registeredWhileNoLongerEligible\".\"registrationId\" AND \"registeredWhileNoLongerEligible\".\"registrationStatus\" = 'registeredWhileNoLongerEligible'  LEFT JOIN \"121-service\".\"registration_status_change\" \"inclusionEnded\" ON \"registration\".\"id\" = \"inclusionEnded\".\"registrationId\" AND \"inclusionEnded\".\"registrationStatus\" = 'inclusionEnded'  LEFT JOIN \"121-service\".\"registration_status_change\" \"deleted\" ON \"registration\".\"id\" = \"deleted\".\"registrationId\" AND \"deleted\".\"registrationStatus\" = 'deleted'  LEFT JOIN \"121-service\".\"registration_status_change\" \"completed\" ON \"registration\".\"id\" = \"completed\".\"registrationId\" AND \"completed\".\"registrationStatus\" = 'completed'  LEFT JOIN (SELECT MAX(\"created\") AS \"created\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"twilio_message\" \"messages\" GROUP BY \"registrationId\") \"messages_max_created\" ON messages_max_created.\"registrationId\" = \"registration\".\"id\"  LEFT JOIN \"121-service\".\"twilio_message\" \"twilioMessages\" ON \"twilioMessages\".\"registrationId\"=\"registration\".\"id\" AND (\"twilioMessages\".\"created\" = messages_max_created.created) ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

    public async down(queryRunner: QueryRunner): Promise<void> {
        await queryRunner.query(`DELETE FROM "121-service"."typeorm_metadata" WHERE "type" = $1 AND "name" = $2 AND "schema" = $3`, ["MATERIALIZED_VIEW","registration_view_entity","121-service"]);
        await queryRunner.query(`DROP MATERIALIZED VIEW "121-service"."registration_view_entity"`);
        await queryRunner.query(`ALTER TABLE "121-service"."twilio_message" DROP CONSTRAINT "FK_cd56d3267e8553557ec97c6741b"`);
        await queryRunner.query(`CREATE VIEW "121-service"."registration_view_entity" AS SELECT DISTINCT ON ("registration"."registrationProgramId") "registration"."id" AS "id", "registration"."programId" AS "programId", "registration"."registrationStatus" AS "status", "registration"."referenceId" AS "referenceId", "registration"."phoneNumber" AS "phoneNumber", "registration"."preferredLanguage" AS "preferredLanguage", "registration"."inclusionScore" AS "inclusionScore", "registration"."paymentAmountMultiplier" AS "paymentAmountMultiplier", "registration"."note" AS "note", "registration"."noteUpdated" AS "noteUpdated", "registration"."registrationProgramId" AS "registrationProgramId", "registration"."maxPayments" AS "maxPayments", "fsp"."fsp" AS "financialServiceProvider", "fsp"."fspDisplayNamePortal" AS "fspDisplayNamePortal", "transaction"."created" AS "lastTransactionCreated", "transaction"."payment" AS "lastTransactionPaymentNumber", "transaction"."status" AS "lastTransactionStatus", "transaction"."amount" AS "lastTransactionAmount", "transaction"."errorMessage" as "lastTransactionErrorMessage", "transaction"."customData" as "lastTransactionCustomData", transaction_max_payment."amountPaymentsReceived" as "amountPaymentsReceived", "imported".created AS "importedDate", "registered".created AS "registeredDate", "invited".created AS "invitedDate", "startedRegistration".created AS "startedRegistrationDate", "selectedForValidation".created AS "selectedForValidationDate", "validated".created AS "validationDate", "included".created AS "inclusionDate", "rejected".created AS "rejectionDate", "noLongerEligible".created AS "noLongerEligibleDate", "registeredWhileNoLongerEligible".created AS "registeredWhileNoLongerEligibleDate", "inclusionEnded".created AS "inclusionEndDate", "deleted".created AS "deleteDate", "completed".created AS "completedDate", "twilioMessages"."status" AS "lastMessageStatus", "twilioMessages"."type" AS "lastMessageType" FROM "121-service"."registration" "registration" LEFT JOIN "121-service"."fsp" "fsp" ON "fsp"."id"="registration"."fspId"  LEFT JOIN (SELECT MAX("payment") AS "payment", COUNT(DISTINCT(payment)) AS "amountPaymentsReceived", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "registrationId") "transaction_max_payment" ON transaction_max_payment."registrationId" = "registration"."id"  LEFT JOIN (SELECT MAX("transactionStep") AS "transactionStep", "payment" AS "payment", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "registrationId") "transaction_max_transaction_step" ON transaction_max_transaction_step."registrationId" = registration.id
      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX("created") AS "created", "payment" AS "payment", "transactionStep" AS "transactionStep", "registrationId" AS "registrationId" FROM "121-service"."transaction" "transactions" GROUP BY "payment", "transactionStep", "registrationId") "transaction_max_created" ON transaction_max_created."registrationId" = registration.id
      AND transaction_max_created.payment = transaction_max_payment.payment
      AND transaction_max_created."transactionStep" = transaction_max_transaction_step."transactionStep"  LEFT JOIN "121-service"."transaction" "transaction" ON "transaction"."registrationId"="registration"."id" AND (transaction."registrationId" = transaction_max_created."registrationId"
      AND "transaction"."payment" = transaction_max_created.payment
      AND transaction."transactionStep" = transaction_max_created."transactionStep"
      AND transaction."created" = transaction_max_created."created")  LEFT JOIN "121-service"."registration_status_change" "imported" ON "registration"."id" = "imported"."registrationId" AND "imported"."registrationStatus" = 'imported'  LEFT JOIN "121-service"."registration_status_change" "registered" ON "registration"."id" = "registered"."registrationId" AND "registered"."registrationStatus" = 'registered'  LEFT JOIN "121-service"."registration_status_change" "invited" ON "registration"."id" = "invited"."registrationId" AND "invited"."registrationStatus" = 'invited'  LEFT JOIN "121-service"."registration_status_change" "startedRegistration" ON "registration"."id" = "startedRegistration"."registrationId" AND "startedRegistration"."registrationStatus" = 'startedRegistration'  LEFT JOIN "121-service"."registration_status_change" "selectedForValidation" ON "registration"."id" = "selectedForValidation"."registrationId" AND "selectedForValidation"."registrationStatus" = 'selectedForValidation'  LEFT JOIN "121-service"."registration_status_change" "validated" ON "registration"."id" = "validated"."registrationId" AND "validated"."registrationStatus" = 'validated'  LEFT JOIN "121-service"."registration_status_change" "included" ON "registration"."id" = "included"."registrationId" AND "included"."registrationStatus" = 'included'  LEFT JOIN "121-service"."registration_status_change" "rejected" ON "registration"."id" = "rejected"."registrationId" AND "rejected"."registrationStatus" = 'rejected'  LEFT JOIN "121-service"."registration_status_change" "noLongerEligible" ON "registration"."id" = "noLongerEligible"."registrationId" AND "noLongerEligible"."registrationStatus" = 'noLongerEligible'  LEFT JOIN "121-service"."registration_status_change" "registeredWhileNoLongerEligible" ON "registration"."id" = "registeredWhileNoLongerEligible"."registrationId" AND "registeredWhileNoLongerEligible"."registrationStatus" = 'registeredWhileNoLongerEligible'  LEFT JOIN "121-service"."registration_status_change" "inclusionEnded" ON "registration"."id" = "inclusionEnded"."registrationId" AND "inclusionEnded"."registrationStatus" = 'inclusionEnded'  LEFT JOIN "121-service"."registration_status_change" "deleted" ON "registration"."id" = "deleted"."registrationId" AND "deleted"."registrationStatus" = 'deleted'  LEFT JOIN "121-service"."registration_status_change" "completed" ON "registration"."id" = "completed"."registrationId" AND "completed"."registrationStatus" = 'completed'  LEFT JOIN (SELECT MAX("created") AS "created", "registrationId" AS "registrationId" FROM "121-service"."twilio_message" "messages" GROUP BY "registrationId") "messages_max_created" ON messages_max_created."registrationId" = "registration"."id"  LEFT JOIN "121-service"."twilio_message" "twilioMessages" ON "twilioMessages"."registrationId"="registration"."id" AND ("twilioMessages"."created" = messages_max_created.created) WHERE 1 = 1 ORDER BY "registration"."registrationProgramId" ASC`);
        await queryRunner.query(`INSERT INTO "121-service"."typeorm_metadata"("database", "schema", "table", "type", "name", "value") VALUES (DEFAULT, $1, DEFAULT, $2, $3, $4)`, ["121-service","VIEW","registration_view_entity","SELECT DISTINCT ON (\"registration\".\"registrationProgramId\") \"registration\".\"id\" AS \"id\", \"registration\".\"programId\" AS \"programId\", \"registration\".\"registrationStatus\" AS \"status\", \"registration\".\"referenceId\" AS \"referenceId\", \"registration\".\"phoneNumber\" AS \"phoneNumber\", \"registration\".\"preferredLanguage\" AS \"preferredLanguage\", \"registration\".\"inclusionScore\" AS \"inclusionScore\", \"registration\".\"paymentAmountMultiplier\" AS \"paymentAmountMultiplier\", \"registration\".\"note\" AS \"note\", \"registration\".\"noteUpdated\" AS \"noteUpdated\", \"registration\".\"registrationProgramId\" AS \"registrationProgramId\", \"registration\".\"maxPayments\" AS \"maxPayments\", \"fsp\".\"fsp\" AS \"financialServiceProvider\", \"fsp\".\"fspDisplayNamePortal\" AS \"fspDisplayNamePortal\", \"transaction\".\"created\" AS \"lastTransactionCreated\", \"transaction\".\"payment\" AS \"lastTransactionPaymentNumber\", \"transaction\".\"status\" AS \"lastTransactionStatus\", \"transaction\".\"amount\" AS \"lastTransactionAmount\", \"transaction\".\"errorMessage\" as \"lastTransactionErrorMessage\", \"transaction\".\"customData\" as \"lastTransactionCustomData\", transaction_max_payment.\"amountPaymentsReceived\" as \"amountPaymentsReceived\", \"imported\".created AS \"importedDate\", \"registered\".created AS \"registeredDate\", \"invited\".created AS \"invitedDate\", \"startedRegistration\".created AS \"startedRegistrationDate\", \"selectedForValidation\".created AS \"selectedForValidationDate\", \"validated\".created AS \"validationDate\", \"included\".created AS \"inclusionDate\", \"rejected\".created AS \"rejectionDate\", \"noLongerEligible\".created AS \"noLongerEligibleDate\", \"registeredWhileNoLongerEligible\".created AS \"registeredWhileNoLongerEligibleDate\", \"inclusionEnded\".created AS \"inclusionEndDate\", \"deleted\".created AS \"deleteDate\", \"completed\".created AS \"completedDate\", \"twilioMessages\".\"status\" AS \"lastMessageStatus\", \"twilioMessages\".\"type\" AS \"lastMessageType\" FROM \"121-service\".\"registration\" \"registration\" LEFT JOIN \"121-service\".\"fsp\" \"fsp\" ON \"fsp\".\"id\"=\"registration\".\"fspId\"  LEFT JOIN (SELECT MAX(\"payment\") AS \"payment\", COUNT(DISTINCT(payment)) AS \"amountPaymentsReceived\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"registrationId\") \"transaction_max_payment\" ON transaction_max_payment.\"registrationId\" = \"registration\".\"id\"  LEFT JOIN (SELECT MAX(\"transactionStep\") AS \"transactionStep\", \"payment\" AS \"payment\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"registrationId\") \"transaction_max_transaction_step\" ON transaction_max_transaction_step.\"registrationId\" = registration.id\n      AND transaction_max_transaction_step.payment = transaction_max_payment.payment  LEFT JOIN (SELECT MAX(\"created\") AS \"created\", \"payment\" AS \"payment\", \"transactionStep\" AS \"transactionStep\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"transaction\" \"transactions\" GROUP BY \"payment\", \"transactionStep\", \"registrationId\") \"transaction_max_created\" ON transaction_max_created.\"registrationId\" = registration.id\n      AND transaction_max_created.payment = transaction_max_payment.payment\n      AND transaction_max_created.\"transactionStep\" = transaction_max_transaction_step.\"transactionStep\"  LEFT JOIN \"121-service\".\"transaction\" \"transaction\" ON \"transaction\".\"registrationId\"=\"registration\".\"id\" AND (transaction.\"registrationId\" = transaction_max_created.\"registrationId\"\n      AND \"transaction\".\"payment\" = transaction_max_created.payment\n      AND transaction.\"transactionStep\" = transaction_max_created.\"transactionStep\"\n      AND transaction.\"created\" = transaction_max_created.\"created\")  LEFT JOIN \"121-service\".\"registration_status_change\" \"imported\" ON \"registration\".\"id\" = \"imported\".\"registrationId\" AND \"imported\".\"registrationStatus\" = 'imported'  LEFT JOIN \"121-service\".\"registration_status_change\" \"registered\" ON \"registration\".\"id\" = \"registered\".\"registrationId\" AND \"registered\".\"registrationStatus\" = 'registered'  LEFT JOIN \"121-service\".\"registration_status_change\" \"invited\" ON \"registration\".\"id\" = \"invited\".\"registrationId\" AND \"invited\".\"registrationStatus\" = 'invited'  LEFT JOIN \"121-service\".\"registration_status_change\" \"startedRegistration\" ON \"registration\".\"id\" = \"startedRegistration\".\"registrationId\" AND \"startedRegistration\".\"registrationStatus\" = 'startedRegistration'  LEFT JOIN \"121-service\".\"registration_status_change\" \"selectedForValidation\" ON \"registration\".\"id\" = \"selectedForValidation\".\"registrationId\" AND \"selectedForValidation\".\"registrationStatus\" = 'selectedForValidation'  LEFT JOIN \"121-service\".\"registration_status_change\" \"validated\" ON \"registration\".\"id\" = \"validated\".\"registrationId\" AND \"validated\".\"registrationStatus\" = 'validated'  LEFT JOIN \"121-service\".\"registration_status_change\" \"included\" ON \"registration\".\"id\" = \"included\".\"registrationId\" AND \"included\".\"registrationStatus\" = 'included'  LEFT JOIN \"121-service\".\"registration_status_change\" \"rejected\" ON \"registration\".\"id\" = \"rejected\".\"registrationId\" AND \"rejected\".\"registrationStatus\" = 'rejected'  LEFT JOIN \"121-service\".\"registration_status_change\" \"noLongerEligible\" ON \"registration\".\"id\" = \"noLongerEligible\".\"registrationId\" AND \"noLongerEligible\".\"registrationStatus\" = 'noLongerEligible'  LEFT JOIN \"121-service\".\"registration_status_change\" \"registeredWhileNoLongerEligible\" ON \"registration\".\"id\" = \"registeredWhileNoLongerEligible\".\"registrationId\" AND \"registeredWhileNoLongerEligible\".\"registrationStatus\" = 'registeredWhileNoLongerEligible'  LEFT JOIN \"121-service\".\"registration_status_change\" \"inclusionEnded\" ON \"registration\".\"id\" = \"inclusionEnded\".\"registrationId\" AND \"inclusionEnded\".\"registrationStatus\" = 'inclusionEnded'  LEFT JOIN \"121-service\".\"registration_status_change\" \"deleted\" ON \"registration\".\"id\" = \"deleted\".\"registrationId\" AND \"deleted\".\"registrationStatus\" = 'deleted'  LEFT JOIN \"121-service\".\"registration_status_change\" \"completed\" ON \"registration\".\"id\" = \"completed\".\"registrationId\" AND \"completed\".\"registrationStatus\" = 'completed'  LEFT JOIN (SELECT MAX(\"created\") AS \"created\", \"registrationId\" AS \"registrationId\" FROM \"121-service\".\"twilio_message\" \"messages\" GROUP BY \"registrationId\") \"messages_max_created\" ON messages_max_created.\"registrationId\" = \"registration\".\"id\"  LEFT JOIN \"121-service\".\"twilio_message\" \"twilioMessages\" ON \"twilioMessages\".\"registrationId\"=\"registration\".\"id\" AND (\"twilioMessages\".\"created\" = messages_max_created.created) WHERE 1 = 1 ORDER BY \"registration\".\"registrationProgramId\" ASC"]);
    }

}
