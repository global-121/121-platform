<p-dialog
  #dialog
  closeOnEscape
  styleClass="md:min-w-[46rem]"
  [(visible)]="dialogVisible"
  [modal]="true"
  [dismissableMask]="true"
>
  <ng-template pTemplate="header">
    <h3>
      <i
        class="pi me-2"
        [class]="icon()"
      ></i>
      <ng-container i18n>{{ headerText() }} registration(s)</ng-container>
    </h3>
  </ng-template>

  <form
    class="block w-full"
    [formGroup]="formGroup"
    (ngSubmit)="onFormSubmit()"
  >
    @let previewMessageData = previewData();
    <div class="space-y-4">
      <p i18n>
        <!-- //##TODO: Make the content dynamic with mapping -->
        You're about to include {{ actionData()?.count }} registrations to your
        project. This means that they can be included in payments.
      </p>

      @if (enableSendMessage()) {
        <p-inputSwitch
          inputId="sendMessage"
          formControlName="checked"
        />
        <label
          for="sendMessage"
          i18n
          >Send a message to registration(s)</label
        >
        @if (formGroup.value.checked) {
          @if (messageTemplates.isPending()) {
            <p>add skeleton</p>
          } @else if (formGroup.value.messageType === 'template') {
            <div>
              @if (previewMessageData) {
                <app-custom-message-preview
                  [projectId]="projectId()"
                  [previewRegistration]="actionData()?.previewItem"
                  [messageData]="previewMessageData"
                ></app-custom-message-preview>
              }
            </div>
          } @else {
            <!-- Custom message -->
            @if (!previewMessageData) {
              <!-- Custom message without any input yet -->
              <div>
                <app-custom-message-control
                  formControlName="customMessage"
                  [projectId]="projectId()"
                  [error]="formFieldErrors()('customMessage')"
                />
                <div class="flex justify-end space-x-2">
                  <p-button
                    label="Cancel"
                    i18n-label="@@generic-cancel"
                    outlined
                    rounded
                    severity="contrast"
                    (click)="dialogVisible.set(false)"
                  />
                  <p-button
                    label="Continue to preview"
                    i18n-label
                    rounded
                    (click)="onProceedToPreview()"
                  />
                </div>
              </div>
            } @else {
              <!-- Custom message with input -->
              <div>
                <app-custom-message-preview
                  [projectId]="projectId()"
                  [previewRegistration]="actionData()?.previewItem"
                  [messageData]="previewMessageData"
                ></app-custom-message-preview>
                <app-form-error
                  [error]="changeStatusMutation.error()?.message"
                />
                <div class="flex justify-end space-x-2">
                  <p-button
                    label="Go back"
                    i18n-label="@@generic-go-back"
                    outlined
                    rounded
                    [disabled]="changeStatusMutation.isPending()"
                    (click)="previewData.set(undefined)"
                  />
                  <p-button
                    label="Approve"
                    i18n-label="@@approve"
                    rounded
                    [loading]="changeStatusMutation.isPending()"
                    type="submit"
                  />
                </div>
              </div>
            }
          }
        }
      }
      @if (
        !enableSendMessage() ||
        (messageTemplates.isSuccess() &&
          (formGroup.value.messageType === 'template' ||
            !formGroup.value.checked))
      ) {
        <div class="flex justify-end space-x-2">
          <p-button
            label="Cancel"
            i18n-label="@@generic-cancel"
            outlined
            rounded
            severity="contrast"
            (click)="dialogVisible.set(false)"
          />
          <p-button
            label="Approve"
            i18n-label="@@approve"
            rounded
            [loading]="changeStatusMutation.isPending()"
            type="submit"
          />
        </div>
      }
    </div>
  </form>
</p-dialog>
