<ion-row
  class="ion-align-items-center ion-justify-content-between ion-margin-bottom"
>
  <div>
    <ion-row>
      <select
        name="bulkActions"
        [title]="
          'page.program.program-people-affected.choose-action' | translate
        "
        (change)="selectAction($event)"
        class="styled-select ion-margin-end"
        [(ngModel)]="action"
      >
        <option value="">
          <ng-container *ngIf="!hasEnabledActions()">{{
            'page.program.program-people-affected.no-actions' | translate
          }}</ng-container>
          <ng-container *ngIf="hasEnabledActions()">{{
            'page.program.program-people-affected.choose-action' | translate
          }}</ng-container>
        </option>

        <ng-container *ngFor="let action of bulkActions">
          <option
            *ngIf="action.enabled"
            [value]="action.id"
            [disabled]="action.id === BulkActionEnum.divider"
          >
            {{ action.label }}
          </option>
        </ng-container>
      </select>
      <confirm-prompt
        [disabled]="applyBtnDisabled"
        (confirm)="applyAction($event)"
        [subHeader]="
          'page.program.program-people-affected.submit-warning' | translate
        "
        [message]="submitWarning.message"
        [inputProps]="getCurrentBulkAction()?.confirmConditions"
        [submitPaymentProps]="submitPaymentProps"
        [action]="action"
        class="ion-float-end"
      >
        {{ 'page.program.program-people-affected.apply-action' | translate }}
      </confirm-prompt>

      <ion-spinner
        *ngIf="isInProgress"
        color="primary"
        class="ion-margin-start"
      ></ion-spinner>
    </ion-row>
  </div>
  <div>
    <ion-input
      [placeholder]="
        'page.program.program-people-affected.filter-placeholder' | translate
      "
      [attr.title]="
        'page.program.program-people-affected.filter-placeholder' | translate
      "
      [attr.aria-label]="
        'page.program.program-people-affected.filter-placeholder' | translate
      "
      (ionChange)="filterRowsVisible($event.target.value)"
      (debounce)="(1000)"
      [value]="filterRowsVisibleQuery"
      [clearInput]="true"
      class="filter-input"
    >
      <ion-icon
        name="funnel"
        [attr.title]="
          'page.program.program-people-affected.filter-placeholder' | translate
        "
        aria-hidden="true"
        size="small"
        slot="start"
        style="padding-inline-start: var(--padding-start)"
      ></ion-icon>
    </ion-input>
  </div>
</ion-row>
<div
  class="proxy-scrollbar"
  data-target="datatable-body"
  data-target-content="datatable-scroller"
>
  <div class="proxy-scrollbar--content"></div>
</div>
<ngx-datatable
  #people
  class="bootstrap data-table--max-height"
  [rowHeight]="80"
  [scrollbarV]="true"
  [scrollbarH]="true"
  [headerHeight]="95"
  [footerHeight]="50"
  [virtualization]="true"
  [reorderable]="false"
  sortType="single"
  [sorts]="[{ prop: 'pa', dir: 'asc' }]"
  [loadingIndicator]="isLoading"
  [columns]="columns"
  [rows]="visiblePeopleAffected"
  selectionType="checkbox"
  [displayCheck]="isRowSelectable"
  [selected]="selectedPeople"
  (select)="onSelect($event.selected)"
  [selectCheck]="isRowSelectable"
>
  <ngx-datatable-column
    prop="selected"
    [width]="75"
    [frozenLeft]="true"
    headerClass="ion-align-self-end"
  >
    <ng-template
      ngx-datatable-header-template
      let-value="value"
      let-allRowsSelected="allRowsSelected"
      let-selectFn="selectFn"
    >
      <label>
        <input
          type="checkbox"
          [checked]="headerChecked"
          [disabled]="!headerSelectAllVisible"
          [ngStyle]="headerSelectAllVisible ? {} : { visibility: 'hidden' }"
          (change)="selectFn(!allRowsSelected)"
        />
        {{ 'page.program.program-people-affected.column.select' | translate }}
      </label>
    </ng-template>

    <ng-template
      ngx-datatable-cell-template
      let-row="row"
      let-value="value"
      let-isSelected="isSelected"
      let-onCheckboxChangeFn="onCheckboxChangeFn"
    >
      <input
        type="checkbox"
        [checked]="isSelected"
        (change)="onCheckboxChangeFn($event)"
        *ngIf="row.checkboxVisible"
      />
    </ng-template>
  </ngx-datatable-column>

  <ngx-datatable-column
    prop="pa"
    [name]="'page.program.program-people-affected.column.person' | translate"
    width="130"
    frozenLeft="true"
    [comparator]="paComparator"
    [draggable]="columnDefaults.draggable"
    [resizeable]="columnDefaults.resizeable"
    [sortable]="columnDefaults.sortable"
    [headerClass]="columnDefaults.headerClass"
  >
    <ng-template ngx-datatable-cell-template let-value="value" let-row="row">
      <div class="ion-align-items-center" style="display: flex">
        <button
          *ngIf="canViewPersonalData"
          id="edit-button"
          type="button"
          class="ion-no-padding popup-button"
          (click)="editPersonAffectedPopup(row, programId)"
          [attr.title]="
            ('page.program.program-people-affected.edit-person-affected-popup.edit-icon-title'
              | translate) +
            (row.hasNote
              ? ' - ' +
                ('page.program.program-people-affected.edit-person-affected-popup.has-notes-title'
                  | translate)
              : '')
          "
          [attr.aria-label]="
            ('page.program.program-people-affected.edit-person-affected-popup.edit-icon-title'
              | translate) +
            (row.hasNote
              ? ' - ' +
                ('page.program.program-people-affected.edit-person-affected-popup.has-notes-title'
                  | translate)
              : '')
          "
        >
          <ion-icon
            name="information"
            size="small"
            aria-hidden="true"
          ></ion-icon>
          <ion-icon
            *ngIf="row.hasNote"
            name="document"
            color="warning"
            size="small"
            aria-hidden="true"
          ></ion-icon>
        </button>
        &nbsp;&nbsp;
        <span>{{ value }}</span>
      </div>
    </ng-template>
  </ngx-datatable-column>

  <ngx-datatable-column
    *ngFor="let column of columns"
    [prop]="column.prop"
    [name]="column.name"
    [width]="column.width"
    [minWidth]="column.minWidth"
    [maxWidth]="column.maxWidth"
    [draggable]="column.draggable"
    [resizeable]="column.resizable"
    [sortable]="column.sortable"
    [comparator]="column.comparator"
    [canAutoResize]="column.canAutoResize"
    [headerClass]="column.headerClass"
    [cellClass]="column.cellClass"
    [frozenLeft]="column.frozenLeft"
  ></ngx-datatable-column>

  <ngx-datatable-column
    name=""
    [width]="emptySeparatorWidth"
    [minWidth]="emptySeparatorWidth"
    [maxWidth]="emptySeparatorWidth"
    [resizeable]="false"
    [sortable]="false"
    headerClass="no-border"
    cellClass="no-border"
    [frozenLeft]="true"
  >
  </ngx-datatable-column>

  <ngx-datatable-column
    *ngIf="
      showInclusionScore() &&
      [
        phaseEnum.registrationValidation,
        phaseEnum.inclusion,
        phaseEnum.reviewInclusion
      ].includes(thisPhase)
    "
    prop="inclusionScore"
    [name]="
      'page.program.program-people-affected.column.inclusion-score' | translate
    "
    minWidth="80"
    [draggable]="columnDefaults.draggable"
    [resizeable]="columnDefaults.resizeable"
    [sortable]="columnDefaults.sortable"
    [headerClass]="columnDefaults.headerClass"
  ></ngx-datatable-column>
  <ngx-datatable-column
    *ngIf="
      showWhatsappNumber() &&
      [
        phaseEnum.registrationValidation,
        phaseEnum.inclusion,
        phaseEnum.reviewInclusion,
        phaseEnum.payment
      ].includes(thisPhase) &&
      canViewPersonalData
    "
    prop="whatsappPhoneNumber"
    [name]="
      'page.program.program-people-affected.column.whatsappPhoneNumber'
        | translate
    "
    minWidth="130"
    [draggable]="columnDefaults.draggable"
    [resizeable]="columnDefaults.resizeable"
    [sortable]="columnDefaults.sortable"
    [headerClass]="columnDefaults.headerClass"
  ></ngx-datatable-column>
  <ngx-datatable-column
    *ngIf="
      showVnumber() &&
      [phaseEnum.reviewInclusion, phaseEnum.payment].includes(thisPhase) &&
      canViewPersonalData
    "
    prop="vnumber"
    [name]="'page.program.program-people-affected.column.vnumber' | translate"
    minWidth="100"
    [draggable]="columnDefaults.draggable"
    [resizeable]="columnDefaults.resizeable"
    [sortable]="columnDefaults.sortable"
    [headerClass]="columnDefaults.headerClass"
  ></ngx-datatable-column>

  <ngx-datatable-column
    *ngFor="let column of customAttributeColumns"
    [prop]="column.prop"
    [name]="column.name"
    [width]="column.width"
    [minWidth]="column.minWidth"
    [maxWidth]="column.maxWidth"
    [draggable]="column.draggable"
    [resizeable]="column.resizable"
    [sortable]="column.sortable"
    [canAutoResize]="column.canAutoResize"
    [headerClass]="column.headerClass"
    [cellClass]="column.cellClass"
  >
    <ng-template ngx-datatable-cell-template let-value="value" let-row="row">
      <span
        *ngIf="value === true"
        [title]="
          'page.program.program-people-affected.column.custom-attribute-true'
            | translate
        "
      >
        <ion-icon class="checkmark true" name="checkmark-circle"></ion-icon>
      </span>
      <span
        *ngIf="value === false"
        [title]="
          'page.program.program-people-affected.column.custom-attribute-false'
            | translate
        "
      >
        <ion-icon class="checkmark" name="ellipse-outline"></ion-icon>
      </span>
      <ng-container *ngIf="value !== true && value !== false && value">
        {{ value }}
      </ng-container>
    </ng-template>
  </ngx-datatable-column>

  <ngx-datatable-column
    *ngIf="thisPhase === phaseEnum.payment"
    prop="lastPayment"
    name="Last payment"
    minWidth="300"
    [draggable]="false"
    [resizeable]="false"
    [sortable]="false"
    [headerClass]="columnDefaults.headerClass"
  >
    <ng-template ngx-datatable-cell-template let-value="value" let-row="row">
      <ng-container>
        <button
          *ngIf="value?.paymentIndex"
          type="button"
          [attr.title]="
            'page.program.program-people-affected.transaction.show-status'
              | translate
          "
          [attr.aria-label]="
            'page.program.program-people-affected.transaction.show-status'
              | translate
          "
          (click)="paymentHistoryPopup(row, programId)"
          [ngClass]="{
            'is-error': hasError(row, value.paymentIndex),
            'no-action':
              !hasVoucherSupport(row.fsp) && !hasError(row, value.paymentIndex),
            'ion-no-padding popup-button status-pop-up': true
          }"
        >
          <div *ngIf="value.paymentIndex" style="margin-bottom: 4px">
            Payment #{{ value.paymentIndex }}
          </div>
          <div style="margin-bottom: 4px">{{ value.text }}</div>
          <div
            style="display: flex"
            class="ion-justify-content-center ion-align-items-center"
          >
            {{ value.amount }}
            <span *ngIf="value.hasMessageIcon || value.hasMoneyIconTable"
              >&nbsp;</span
            >
            <ion-icon
              *ngIf="value.hasMessageIcon"
              name="mail"
              size="small"
              aria-hidden="true"
            ></ion-icon>
            <ion-icon
              *ngIf="value.hasMoneyIconTable"
              name="cash"
              size="small"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </button>
        <span *ngIf="!value?.paymentIndex">
          {{ value.text }}
        </span>
      </ng-container>
    </ng-template>
  </ngx-datatable-column>

  <!-- <ngx-datatable-column
    *ngFor="let column of paymentColumns"
    [prop]="column.prop"
    [name]="column.name"
    [width]="column.width"
    [minWidth]="column.minWidth"
    [maxWidth]="column.maxWidth"
    [draggable]="column.draggable"
    [resizeable]="column.resizable"
    [sortable]="column.sortable"
    [canAutoResize]="column.canAutoResize"
    [headerClass]="column.headerClass"
    [cellClass]="column.cellClass"
  >
    <ng-template
      ngx-datatable-cell-template
      let-value="value"
      let-row="row"
    >
      <ng-container *ngIf="value">
        <button
          type="button"
          (click)="statusPopup(row, column, value)"
          [ngClass]="{
            'is-error': hasError(row, column.paymentIndex),
            'no-action': !hasVoucherSupport(row.fsp) && !hasError(row, column.paymentIndex),
            'ion-no-padding popup-button status-pop-up': true
           }"
          [attr.title]="'page.program.program-people-affected.transaction.show-status'|translate"
          [attr.aria-label]="'page.program.program-people-affected.transaction.show-status'|translate"
        >
          {{ value.text }}
          <div style="display: flex;" class="ion-justify-content-center ion-align-items-center">
            {{ value.amount }}
            <span *ngIf="value.hasMessageIcon || value.hasMoneyIconTable">&nbsp;</span>
            <ion-icon
              *ngIf="value.hasMessageIcon"
              name="mail"
              size="small"
              aria-hidden="true"
            ></ion-icon>
            <ion-icon
              *ngIf="value.hasMoneyIconTable"
              name="cash"
              size="small"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </button>
      </ng-container>
      <ng-container
        *ngIf="enableSinglePayment(row,column)"
      >
        <button
          type="button"
          (click)="statusPopup(row, column, value)"
          [ngClass]="{
            'is-error': hasError(row, column.paymentIndex),
            'ion-no-padding popup-button': true
          }"
        >
          {{ 'page.program.program-people-affected.transaction.do-single-payment'|translate }}
          <br>
          <ion-icon
            name="add-circle-outline"
            size="small"
            aria-hidden="true"
          ></ion-icon>
        </button>
      </ng-container>
    </ng-template>
  </ngx-datatable-column> -->
</ngx-datatable>
