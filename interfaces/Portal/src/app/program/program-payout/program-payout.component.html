<div
  *ngIf="canMakeExport"
  class="ion-margin-vertical"
>
  <h3>{{ 'page.program.program-payout.make-export' | translate }}</h3>
  <ion-row class="ion-align-items-center">
    <select
      [title]="'page.program.program-payout.choose-payment' | translate"
      [(ngModel)]="exportPaymentId"
      (change)="changeExportPayment()"
      class="styled-select ion-margin-end"
    >
      <option [value]="0">
        <ng-container>{{
          'page.program.program-payout.choose-payment' | translate
        }}</ng-container>
      </option>
      <option
        [value]="-1"
        [disabled]="lastPaymentId < 1"
      >
        {{ 'page.program.program-payout.all-closed-payments' | translate }}
      </option>
      <option
        *ngFor="let payment of payments"
        [value]="payment.id"
        [disabled]="!payment.isExportAvailable"
      >
        {{
          'page.program.program-payout.payment-nr'
            | translate: { number: payment.id }
        }}

        <ng-container *ngIf="payment.statusOpen">
          {{ 'page.program.program-payout.open' | translate }}
        </ng-container>
        <ng-container *ngIf="!payment.statusOpen">
          {{ 'page.program.program-payout.closed' | translate }}
        </ng-container>
        -
        {{ payment.paymentDate | date: DateFormat.dateOnly }}
      </option>
    </select>

    <app-export-list
      [programId]="programId"
      [exportType]="exportPaymentType"
      [minPayment]="minPayment"
      [maxPayment]="maxPayment"
      [disabled]="!exportPaymentAvailable"
    ></app-export-list>

    <app-export-fsp-instructions
      *ngIf="hasFspWithExportFileIntegration && canMakeFspInstructions"
      [programId]="programId"
      [payment]="exportPaymentId"
      [lastPaymentId]="lastPaymentId"
      [hasFspWithReconciliation]="hasFspWithReconciliation"
    ></app-export-fsp-instructions>
    <app-import-fsp-reconciliation
      *ngIf="hasFspWithReconciliation && canMakeFspInstructions"
      [programId]="programId"
      [payment]="exportPaymentId"
      [lastPaymentId]="lastPaymentId"
      [fspIds]="fspIdsWithReconciliation"
    ></app-import-fsp-reconciliation>
  </ion-row>
  <ion-row class="ion-margin-vertical">
    <app-export-list
      *ngIf="programHasVoucherSupport"
      [programId]="programId"
      [exportType]="enumExportType.unusedVouchers"
      class="ion-margin-end"
    >
    </app-export-list>

    <app-export-list
      *ngIf="canExportCardBalances"
      [programId]="programId"
      [exportType]="exportCardUsageType"
      [minPayment]="minPayment"
      [maxPayment]="maxPayment"
    ></app-export-list>

    <ng-container *ngIf="showCbeValidationButton">
      <app-download-cbe-verification-report [programId]="programId" />
    </ng-container>
  </ion-row>
</div>

<ion-row
  *ngIf="canViewPayment"
  class="ion-margin-vertical"
>
  <ion-col
    *ngIf="!!lastPaymentId"
    [sizeXs]="12"
    [sizeMd]="4"
  >
    <h3>
      {{
        'page.program.program-payout.last-payment.last-payment'
          | translate: { nr: lastPaymentId ? '#' + lastPaymentId : '-' }
      }}
    </h3>
    <p *ngIf="lastPaymentResults">
      {{ 'page.program.program-payout.last-payment.success' | translate }}:
      <strong>{{ lastPaymentResults.success }}</strong
      ><br />
      {{ 'page.program.program-payout.last-payment.waiting' | translate }}:
      <strong>{{ lastPaymentResults.waiting }}</strong
      ><br />
      {{ 'page.program.program-payout.last-payment.error' | translate }}:
      <strong>{{ lastPaymentResults.error }}</strong>
    </p>
    <ion-row
      *ngIf="canMakePayment && lastPaymentResults?.error > 0"
      class="ion-align-items-center"
    >
      <app-confirm-prompt
        (confirm)="retryLastPayment()"
        [subHeader]="
          'page.program.program-payout.last-payment.confirm-prompt'
            | translate: { number: lastPaymentResults?.error }
        "
        fill="outline"
        color="danger"
        [disabled]="paymentInProgress"
      >
        <ion-icon
          name="refresh"
          size="small"
          slot="start"
          aria-hidden="true"
        ></ion-icon>
        {{
          'page.program.program-payout.last-payment.retry-all'
            | translate: { number: lastPaymentResults?.error }
        }}
      </app-confirm-prompt>
      <div
        *ngIf="paymentInProgress"
        class="ion-margin-start ion-align-items-center"
        style="display: flex"
      >
        <ion-note>
          {{ 'page.program.program-payout.in-progress' | translate }}
        </ion-note>
        <ion-button
          size="small"
          fill="clear"
          [title]="'common.update' | translate"
          [attr.aria-label]="'common.update' | translate"
          (click)="refresh()"
        >
          <ion-icon
            name="refresh"
            size="small"
            slot="icon-only"
            aria-hidden="true"
          ></ion-icon>
        </ion-button>
      </div>
    </ion-row>
  </ion-col>
</ion-row>
